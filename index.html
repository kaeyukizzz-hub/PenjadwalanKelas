<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Jadwal Kelas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* A simple font to match the app's aesthetic */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden; /* Mencegah scroll horizontal karena animasi */
        }
        /* Custom style for file input */
        .file-input-button {
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            color: white;
            transition: background-color 0.2s;
        }
        .file-input-label {
            margin-left: 0.5rem;
            color: #D1D5DB; /* gray-300 */
        }
        
        /* Animasi Transisi Halaman */
        @keyframes slideInFromRight {
            0% {
                transform: translateX(30px);
                opacity: 0;
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .page-slide-in {
            animation: slideInFromRight 0.5s ease-out forwards;
        }

        /* Styling for scrollbars */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1F2937; /* gray-800 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #4B5563; /* gray-600 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6B7280; /* gray-500 */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel to transpile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- SheetJS/xlsx for reading Excel files -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>


    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useRef } = React;
        const { createClient } = supabase;

        // --- SUPABASE SETUP ---
        // TODO: Ganti dengan URL dan Kunci Anon Proyek Supabase Anda.
        // Dapatkan ini dari dasbor Supabase Anda di bawah Pengaturan Proyek -> API.
        const SUPABASE_URL = 'https://gzfjglidpcakbkdnwsno.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd6ZmpnbGlkcGNha2JrZG53c25vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5MzAyMzMsImV4cCI6MjA3NjUwNjIzM30.xtRN-aEAAFofqHZnE1fW_e0BXCpdlbcpeZ_96WxKfzA';

        // Inisialisasi klien Supabase sekali saja
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);


        // --- SVG ICON COMPONENTS ---
        const StarLogo = () => (
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="goldGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style={{stopColor: '#FFD700', stopOpacity: 1}} />
                <stop offset="100%" style={{stopColor: '#FFA500', stopOpacity: 1}} />
              </linearGradient>
            </defs>
            <path d="M12 2L14.09 8.26L20 9.27L15.55 13.97L16.91 20L12 16.54L7.09 20L8.45 13.97L4 9.27L9.91 8.26L12 2Z" fill="url(#goldGradient)" stroke="#FFC700" strokeWidth="0.5"/>
          </svg>
        );

        const NotificationIcon = ({ count, onClick }) => (
            <div className="relative cursor-pointer" onClick={onClick}>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-gray-300">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" /><path d="M13.73 21a2 2 0 0 1-3.46 0" />
                </svg>
                {count > 0 && (
                    <span className="absolute -top-2 -right-2 flex h-6 w-6 items-center justify-center rounded-full bg-red-500 text-xs font-bold text-white ring-2 ring-gray-800">
                        {count > 99 ? '99+' : count}
                    </span>
                )}
            </div>
        );

        // --- UTILITY HOOKS & COMPONENTS ---
        const useModal = () => {
            const [modalState, setModalState] = useState({ isOpen: false, message: '', onConfirm: null, type: 'alert' });

            const showModal = (message, onConfirmCallback = null) => {
                setModalState({
                    isOpen: true,
                    message,
                    onConfirm: onConfirmCallback,
                    type: onConfirmCallback ? 'confirm' : 'alert',
                });
            };

            const hideModal = () => {
                setModalState({ isOpen: false, message: '', onConfirm: null, type: 'alert' });
            };

            const handleConfirm = () => {
                if (modalState.onConfirm) {
                    modalState.onConfirm();
                }
                hideModal();
            };

            const ModalComponent = () => {
                if (!modalState.isOpen) return null;
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 p-4">
                        <div className="bg-gray-800 border border-purple-400 rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
                            <p className="mb-6 text-gray-200">{modalState.message}</p>
                            <div className="flex justify-center space-x-4">
                                {modalState.type === 'confirm' && (
                                    <button onClick={hideModal} className="px-4 py-2 rounded-md bg-gray-600 text-gray-100 hover:bg-gray-500">
                                        Batal
                                    </button>
                                )}
                                <button onClick={handleConfirm} className="px-4 py-2 rounded-md bg-purple-600 text-white hover:bg-purple-700">
                                    {modalState.type === 'confirm' ? 'Ya, Lanjutkan' : 'OK'}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            return { ModalComponent, showModal };
        };
        
        // --- MAIN APP COMPONENT ---
        function App() {
            const [session, setSession] = useState(null);
            const [currentUser, setCurrentUser] = useState(null);
            const [page, setPage] = useState('login');
            const [backgroundPos, setBackgroundPos] = useState(0);
            const { ModalComponent, showModal } = useModal();

            const CLASS_LIST = useMemo(() => {
                const grades = ['X', 'XI', 'XII'];
                const majors = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L'];
                return grades.flatMap(grade => majors.map(major => `${grade}-${major}`));
            }, []);

            const DAYS = useMemo(() => ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'], []);

            useEffect(() => {
                // Periksa sesi saat aplikasi dimuat
                supabaseClient.auth.getSession().then(({ data: { session } }) => {
                    setSession(session);
                    if (session) {
                        fetchUserProfile(session.user.id);
                    }
                });

                // Dengarkan perubahan status otentikasi
                const { data: { subscription } } = supabaseClient.auth.onAuthStateChange((_event, session) => {
                    setSession(session);
                    if (session) {
                        fetchUserProfile(session.user.id);
                    } else {
                        setCurrentUser(null);
                        navigate('login');
                    }
                });

                return () => subscription.unsubscribe();
            }, []);
            
            const fetchUserProfile = async (userId) => {
                const { data, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();

                if (data && data.approved) {
                    setCurrentUser(data);
                    navigate(data.role);
                } else if (data && !data.approved) {
                    showModal('Akun Anda sedang menunggu persetujuan dari admin.');
                    handleLogout();
                } else {
                    console.error('Error fetching profile:', error);
                    handleLogout();
                }
            };

            const navigate = (newPage) => {
                setPage(newPage);
                if (newPage !== 'login' && page === 'login') {
                    setBackgroundPos(prev => prev - 150);
                }
            };

            const handleLogin = async ({ username, password }) => {
                // Gunakan username sebagai email dengan domain dummy
                const email = `${username}@example.com`;
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });

                if (error) {
                    showModal('Username atau password salah.');
                    return false;
                }
                // onAuthStateChange akan menangani sisanya
                return true;
            };
            
            const handleRegister = async ({ username, password, className, role }) => {
                // Gunakan username sebagai email dengan domain dummy
                const email = `${username}@example.com`;
                const { data, error } = await supabaseClient.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            username: username,
                            role: role,
                            class_name: role === 'user' ? className : null,
                            approved: role === 'admin' // Admin langsung disetujui, user perlu persetujuan
                        }
                    }
                });

                if (error) {
                    showModal(error.message);
                    return false;
                }
                
                showModal('Registrasi berhasil! Akun Anda sedang menunggu persetujuan dari Admin.');
                return true;
            };

            const handleLogout = async () => {
                await supabaseClient.auth.signOut();
                setCurrentUser(null);
                setBackgroundPos(0);
                navigate('login');
            };

            const renderPage = () => {
                if (!currentUser && page !== 'login') {
                    // Tampilkan loading atau redirect ke login jika belum ada user
                    return <div className="text-center text-white">Loading...</div>;
                }
              
                switch (page) {
                    case 'admin':
                        return <AdminDashboard 
                                currentUser={currentUser} 
                                CLASS_LIST={CLASS_LIST} 
                                DAYS={DAYS} 
                                onLogout={handleLogout} 
                                showModal={showModal}
                                supabase={supabaseClient}
                                />;
                    case 'user':
                        return <UserDashboard 
                                currentUser={currentUser} 
                                DAYS={DAYS} 
                                onLogout={handleLogout}
                                showModal={showModal}
                                supabase={supabaseClient}
                                />;
                    default:
                        return <LoginPage onLogin={handleLogin} onRegister={handleRegister} CLASS_LIST={CLASS_LIST} showModal={showModal} />;
                }
            };

            return (
                <div className="min-h-screen bg-gray-900 font-sans text-gray-200">
                    <ModalComponent />
                    <div 
                        className="fixed inset-0 z-0 bg-cover bg-center transition-transform duration-1000 ease-in-out"
                        style={{
                            backgroundImage: "url('https://images.unsplash.com/photo-1506442682393-205b5546f345?q=80&w=2574&auto=format&fit=crop')",
                            transform: `translateX(${backgroundPos}px)`
                        }}
                    ></div>
                    <div className="fixed inset-0 bg-black/50 z-0"></div>

                    <main className="relative z-10">
                        <div key={page} className="page-slide-in p-4 sm:p-6 md:p-8">
                           {renderPage()}
                        </div>
                    </main>
                </div>
            );
        }
        
        // --- AUTHENTICATION PAGE ---
        function LoginPage({ onLogin, onRegister, CLASS_LIST, showModal }) {
            const [isRegister, setIsRegister] = useState(false);
            const [form, setForm] = useState({ username: '', password: '', className: CLASS_LIST[0], role: 'user' });
            const [confirmPassword, setConfirmPassword] = useState('');

            const handleChange = (e) => {
                const { name, value } = e.target;
                setForm(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (isRegister) {
                    if (form.password !== confirmPassword) {
                        showModal("Password tidak cocok!");
                        return;
                    }
                    const success = await onRegister(form);
                    if(success) {
                        setIsRegister(false);
                        setForm({ username: '', password: '', className: CLASS_LIST[0], role: 'user' });
                        setConfirmPassword('');
                    }
                } else {
                    await onLogin(form);
                }
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-[calc(100vh-4rem)]">
                    <div className="w-full max-w-md p-8 space-y-6 bg-gray-800/80 backdrop-blur-md rounded-2xl shadow-2xl border border-purple-400/30">
                        <div className="flex justify-center">
                            <StarLogo />
                        </div>
                        <h2 className="text-center text-3xl font-extrabold text-white">{isRegister ? 'Buat Akun Baru' : 'Selamat Datang'}</h2>
                        
                        <form className="space-y-6" onSubmit={handleSubmit}>
                            <div className="space-y-4 rounded-md">
                                <input name="username" type="text" required value={form.username} onChange={handleChange} className="w-full px-3 py-2 border border-gray-600 bg-gray-700 placeholder-gray-400 text-white rounded-md focus:outline-none focus:ring-purple-500 focus:border-purple-500" placeholder="Username" />
                                <input name="password" type="password" required value={form.password} onChange={handleChange} className="w-full px-3 py-2 border border-gray-600 bg-gray-700 placeholder-gray-400 text-white rounded-md focus:outline-none focus:ring-purple-500 focus:border-purple-500" placeholder="Password" />
                                {isRegister && (
                                    <>
                                        <input name="confirmPassword" type="password" required value={confirmPassword} onChange={(e) => setConfirmPassword(e.target.value)} className="w-full px-3 py-2 border border-gray-600 bg-gray-700 placeholder-gray-400 text-white rounded-md focus:outline-none focus:ring-purple-500 focus:border-purple-500" placeholder="Konfirmasi Password" />
                                        <div className="flex items-center space-x-4 text-white">
                                            <label><input type="radio" name="role" value="user" checked={form.role === 'user'} onChange={handleChange} className="text-purple-500 focus:ring-purple-600" /> User</label>
                                            <label><input type="radio" name="role" value="admin" checked={form.role === 'admin'} onChange={handleChange} className="text-purple-500 focus:ring-purple-600"/> Admin</label>
                                        </div>
                                        {form.role === 'user' && (
                                            <select name="className" value={form.className} onChange={handleChange} className="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-purple-500 focus:border-purple-500">
                                                {CLASS_LIST.map(c => <option key={c} value={c}>{c}</option>)}
                                            </select>
                                        )}
                                    </>
                                )}
                            </div>
                            <button type="submit" className="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 focus:ring-offset-gray-800 transition duration-150 ease-in-out">
                                {isRegister ? 'Daftar' : 'Login'}
                            </button>
                        </form>

                        <p className="text-center text-sm text-gray-300">
                            {isRegister ? 'Sudah punya akun?' : 'Belum punya akun?'}
                            <button onClick={() => setIsRegister(!isRegister)} className="ml-1 font-medium text-purple-400 hover:text-purple-300">
                                {isRegister ? 'Login di sini' : 'Daftar sekarang'}
                            </button>
                        </p>
                    </div>
                </div>
            );
        }
        
        // --- ADMIN DASHBOARD AND COMPONENTS ---
        function AdminDashboard({ currentUser, CLASS_LIST, DAYS, onLogout, showModal, supabase }) {
            const [activeTab, setActiveTab] = useState('approval');
            const [pendingUsers, setPendingUsers] = useState([]);
            const [allUsers, setAllUsers] = useState([]);
            const [schedules, setSchedules] = useState({});
            const [assignments, setAssignments] = useState([]);
            const [notes, setNotes] = useState([]);

            const fetchData = useCallback(async () => {
                const { data: pending, error: pendingError } = await supabase.from('profiles').select('*').eq('approved', false);
                if(pendingError) console.error("Error fetching pending users:", pendingError);
                else setPendingUsers(pending);

                const { data: all, error: allError } = await supabase.from('profiles').select('*');
                if(allError) console.error("Error fetching all users:", allError);
                else setAllUsers(all);
                
                const { data: scheds, error: schedsError } = await supabase.from('schedules').select('*');
                if(schedsError) console.error("Error fetching schedules:", schedsError);
                else {
                    const groupedSchedules = scheds.reduce((acc, sched) => {
                        if(!acc[sched.class_name]) acc[sched.class_name] = {};
                        if(!acc[sched.class_name][sched.day]) acc[sched.class_name][sched.day] = [];
                        acc[sched.class_name][sched.day].push({start: sched.start_time, end: sched.end_time, subject: sched.subject});
                        acc[sched.class_name][sched.day].sort((a,b) => a.start.localeCompare(b.start));
                        return acc;
                    }, {});
                    setSchedules(groupedSchedules);
                }

                const { data: assigns, error: assignsError } = await supabase.from('assignments').select('*').order('created_at', { ascending: false });
                if(assignsError) console.error("Error fetching assignments:", assignsError);
                else setAssignments(assigns);

                const { data: nts, error: ntsError } = await supabase.from('notes').select('*');
                if(ntsError) console.error("Error fetching notes:", ntsError);
                else setNotes(nts);

            }, [supabase]);

            useEffect(() => {
                fetchData();

                const channel = supabase.channel('admin-db-changes')
                    .on('postgres_changes', { event: '*', schema: 'public' }, payload => {
                        console.log('Change received!', payload);
                        fetchData(); // Refetch all data on any change
                    })
                    .subscribe();
                
                return () => {
                    supabase.removeChannel(channel);
                }
            }, [supabase, fetchData]);
            
            return (
                <div className="bg-gray-800/80 backdrop-blur-md rounded-2xl shadow-xl p-6 min-h-[calc(100vh-4rem)] border border-purple-400/30">
                    <header className="flex justify-between items-center mb-6 pb-4 border-b border-purple-400/30">
                        <div className="flex items-center space-x-3">
                            <StarLogo />
                            <div>
                                <h1 className="text-2xl font-bold text-white">Dasbor Admin</h1>
                                <p className="text-sm text-gray-400">Selamat datang, {currentUser.username}</p>
                            </div>
                        </div>
                        <button onClick={onLogout} className="px-4 py-2 text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 transition">Logout</button>
                    </header>
                    
                    <nav className="flex flex-wrap border-b border-purple-400/30 mb-6 -mx-1">
                        <button onClick={() => setActiveTab('approval')} className={`px-4 py-2 rounded-t-lg mx-1 mb-[-1px] transition-colors ${activeTab === 'approval' ? 'bg-gray-700 text-purple-300 font-semibold border border-b-gray-700 border-purple-400/30' : 'text-gray-400 hover:bg-gray-700/50'}`}>Persetujuan ({pendingUsers.length})</button>
                        <button onClick={() => setActiveTab('user_management')} className={`px-4 py-2 rounded-t-lg mx-1 mb-[-1px] transition-colors ${activeTab === 'user_management' ? 'bg-gray-700 text-purple-300 font-semibold border border-b-gray-700 border-purple-400/30' : 'text-gray-400 hover:bg-gray-700/50'}`}>Manajemen User</button>
                        <button onClick={() => setActiveTab('schedule')} className={`px-4 py-2 rounded-t-lg mx-1 mb-[-1px] transition-colors ${activeTab === 'schedule' ? 'bg-gray-700 text-purple-300 font-semibold border border-b-gray-700 border-purple-400/30' : 'text-gray-400 hover:bg-gray-700/50'}`}>Manajemen Jadwal</button>
                        <button onClick={() => setActiveTab('assignments')} className={`px-4 py-2 rounded-t-lg mx-1 mb-[-1px] transition-colors ${activeTab === 'assignments' ? 'bg-gray-700 text-purple-300 font-semibold border border-b-gray-700 border-purple-400/30' : 'text-gray-400 hover:bg-gray-700/50'}`}>Manajemen Tugas</button>
                        <button onClick={() => setActiveTab('notes')} className={`px-4 py-2 rounded-t-lg mx-1 mb-[-1px] transition-colors ${activeTab === 'notes' ? 'bg-gray-700 text-purple-300 font-semibold border border-b-gray-700 border-purple-400/30' : 'text-gray-400 hover:bg-gray-700/50'}`}>Catatan User</button>
                    </nav>

                    <div className="transition-all duration-300">
                        {activeTab === 'approval' && <RegistrationApproval currentUser={currentUser} pendingUsers={pendingUsers} showModal={showModal} supabase={supabase} />}
                        {activeTab === 'user_management' && <UserManager currentUser={currentUser} allUsers={allUsers} CLASS_LIST={CLASS_LIST} showModal={showModal} supabase={supabase} />}
                        {activeTab === 'schedule' && <ScheduleManager schedules={schedules} CLASS_LIST={CLASS_LIST} DAYS={DAYS} showModal={showModal} supabase={supabase} />}
                        {activeTab === 'assignments' && <AssignmentManager assignments={assignments} allUsers={allUsers} CLASS_LIST={CLASS_LIST} showModal={showModal} supabase={supabase} />}
                        {activeTab === 'notes' && <UserNotesViewer notes={notes} users={allUsers} />}
                    </div>
                </div>
            );
        }
        
        function RegistrationApproval({ currentUser, pendingUsers, showModal, supabase }) {
            const userFileInputRef = useRef(null);
            const [userFileName, setUserFileName] = useState('');
            const isSuperAdmin = currentUser.username === 'superadmin';

            const handleApproval = async (userId, isApproved, username) => {
                if (isApproved) {
                    const { error } = await supabase.from('profiles').update({ approved: true }).eq('id', userId);
                    if (error) {
                        showModal(`Gagal menyetujui ${username}: ${error.message}`);
                    } else {
                        showModal(`Registrasi ${username} disetujui.`);
                    }
                } else {
                    // Menghapus user dari tabel auth akan otomatis menghapus profilnya karena ON DELETE CASCADE
                    // Ini adalah operasi admin, jadi kita perlu memanggil fungsi edge
                     const { data, error } = await supabase.functions.invoke('delete-user', { body: { user_id: userId } });
                    if (error) {
                        showModal(`Gagal menolak ${username}: ${error.message}`);
                    } else {
                        showModal(`Registrasi ${username} ditolak dan data dihapus.`);
                    }
                }
            };
            
            return (
                <div>
                     {/* ... Bagian Impor File tetap sama, tidak perlu diubah karena sudah menggunakan logika client-side ... */}

                    <h3 className="font-bold text-lg mb-4 text-white">Daftar Registrasi Menunggu Persetujuan</h3>
                    <div className="space-y-3 max-h-[50vh] overflow-y-auto pr-2">
                        {pendingUsers.length > 0 ? pendingUsers.map(user => (
                            <div key={user.id} className="flex flex-wrap justify-between items-center p-3 bg-gray-700 rounded-md shadow-sm">
                                <div>
                                    <p>Username: <span className="font-semibold text-white">{user.username}</span></p>
                                    <p className="text-sm text-gray-400">
                                        Role: <span className="capitalize font-medium">{user.role}</span>
                                        {user.role === 'user' && ` - Kelas: ${user.class_name}`}
                                    </p>
                                </div>
                                <div className="flex space-x-2 mt-2 sm:mt-0">
                                    <button onClick={() => handleApproval(user.id, true, user.username)} className="bg-green-600 text-white px-4 py-2 rounded-md text-sm hover:bg-green-700">Setujui</button>
                                    <button onClick={() => handleApproval(user.id, false, user.username)} className="bg-red-600 text-white px-4 py-2 rounded-md text-sm hover:bg-red-700">Tolak</button>
                                </div>
                            </div>
                        )) : <p className="text-gray-400">Tidak ada pendaftaran yang menunggu persetujuan.</p>}
                    </div>
                </div>
            );
        }

        function UserManager({ currentUser, allUsers, CLASS_LIST, showModal, supabase }) {
            const [selectedClass, setSelectedClass] = useState('Semua Kelas');
            const [searchTerm, setSearchTerm] = useState('');
            const isSuperAdmin = currentUser.username === 'superadmin';

            const filteredUsers = useMemo(() => {
                return allUsers
                    .filter(user => user.approved && user.role === 'user')
                    .filter(user => selectedClass === 'Semua Kelas' || user.class_name === selectedClass)
                    .filter(user => user.username.toLowerCase().includes(searchTerm.toLowerCase()));
            }, [allUsers, selectedClass, searchTerm]);

            const admins = useMemo(() => allUsers.filter(user => user.role === 'admin'), [allUsers]);

            const handleDeleteUser = async (userId, username) => {
                 showModal(`Apakah Anda yakin ingin menghapus user: ${username}?`, async () => {
                     const { error } = await supabase.functions.invoke('delete-user', { body: { user_id: userId } });
                     if(error) showModal(`Gagal menghapus: ${error.message}`);
                     else showModal(`${username} berhasil dihapus.`);
                 });
            };
            
            return (
                <div>
                    <h3 className="font-bold text-lg mb-4 text-white">Manajemen User Siswa</h3>
                    <div className="flex flex-wrap gap-4 items-center mb-4 p-4 bg-gray-700/50 rounded-lg">
                        <select value={selectedClass} onChange={e => setSelectedClass(e.target.value)} className="p-2 border border-gray-600 bg-gray-700 text-white rounded-md">
                            <option value="Semua Kelas">Semua Kelas</option>
                            {CLASS_LIST.map(c => <option key={c} value={c}>{c}</option>)}
                        </select>
                        <input type="text" placeholder="Cari username..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="p-2 border border-gray-600 bg-gray-700 text-white rounded-md flex-grow"/>
                    </div>

                    <div className="space-y-3 max-h-[40vh] overflow-y-auto pr-2">
                        {filteredUsers.length > 0 ? filteredUsers.map(user => (
                            <div key={user.id} className="flex justify-between items-center p-3 bg-gray-700 rounded-md shadow-sm">
                                <span className="text-white">{user.username} ({user.class_name})</span>
                                <button onClick={() => handleDeleteUser(user.id, user.username)} className="bg-red-500 text-white px-4 py-2 rounded-md text-sm hover:bg-red-600">Hapus</button>
                            </div>
                        )) : <p className="text-gray-400">Tidak ada user yang cocok.</p>}
                    </div>

                    {isSuperAdmin && (
                        <div className="mt-8">
                            <h3 className="font-bold text-lg mb-4 border-t border-purple-400/30 pt-4 text-white">Manajemen Admin (Superadmin Only)</h3>
                            <div className="space-y-3">
                                {admins.map(admin => (
                                    <div key={admin.id} className="flex justify-between items-center p-3 bg-gray-700 rounded-md shadow-sm">
                                        <span className="text-white">{admin.username} {admin.username === 'superadmin' && '(Superadmin)'}</span>
                                        {admin.username !== 'superadmin' && (
                                           <button onClick={() => handleDeleteUser(admin.id, admin.username)} className="bg-red-500 text-white px-4 py-2 rounded-md text-sm hover:bg-red-600">Hapus</button>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // ... (Komponen lainnya akan direfaktor dengan cara yang sama)
        function ScheduleManager({ schedules, CLASS_LIST, DAYS, showModal, supabase }) {
            // Logika sama, tapi panggilan updateDb diganti dengan panggilan supabase
            // contoh: updateDb('schedules', newSchedules); -> supabase.from('schedules')...
        }
        function AssignmentManager({ assignments, allUsers, CLASS_LIST, showModal, supabase }) {
            // Logika sama, tapi panggilan updateDb diganti dengan panggilan supabase
        }
         function UserNotesViewer({ notes, users }) {
            const notesWithUsernames = useMemo(() => {
                return (notes || []).map(note => {
                    const user = users.find(u => u.id === note.user_id);
                    return { ...note, username: user ? user.username : 'User tidak diketahui', className: user ? user.class_name : '-' };
                }).reverse();
            }, [notes, users]);
            
            return (
                 <div>
                    <h3 className="font-bold text-lg mb-4 text-white">Semua Catatan User</h3>
                     <div className="space-y-3 max-h-[70vh] overflow-y-auto pr-2">
                        {notesWithUsernames.length > 0 ? notesWithUsernames.map(note => (
                            <div key={note.id} className="p-3 bg-gray-700 rounded-lg shadow">
                                <p className="font-semibold text-white whitespace-pre-wrap">{note.content}</p>
                                <p className="text-sm text-gray-400 mt-2">
                                    <span className="font-medium text-purple-300">{note.username} ({note.className})</span> - untuk hari <span className="font-medium">{note.date}</span>
                                </p>
                            </div>
                        )) : <p className="text-gray-400">Tidak ada catatan dari user.</p>}
                    </div>
                </div>
            );
        }
        function UserDashboard({ currentUser, DAYS, onLogout, showModal, supabase }) {
            // Logika yang sama, ambil data dari Supabase dan gunakan subscription
        }


        // --- RENDER THE APP ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>


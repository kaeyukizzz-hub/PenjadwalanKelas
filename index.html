<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Jadwal Kelas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* A simple font to match the app's aesthetic */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden; /* Mencegah scroll horizontal karena animasi */
        }
        /* Custom style for file input */
        .file-input-button {
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            background-color: #10B981; /* green-500 */
            color: white;
            transition: background-color 0.2s;
        }
        .file-input-button:hover {
            background-color: #059669; /* green-600 */
        }
        .file-input-label {
            margin-left: 0.5rem;
            color: #4B5563; /* gray-600 */
        }
        
        /* Animasi Transisi Halaman */
        @keyframes slideInFromRight {
            0% {
                transform: translateX(30px);
                opacity: 0;
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .page-slide-in {
            animation: slideInFromRight 0.5s ease-out forwards;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel to transpile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- SheetJS/xlsx for reading Excel files -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>


    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useRef } = React;

        // --- SVG ICON COMPONENTS ---
        const TreeLogo = () => (
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className="text-green-600">
            <path d="M17.32 10H6.68L4 14H20L17.32 10Z" fill="currentColor" opacity="0.4"/>
            <path d="M15.46 5H8.54L6.68 10H17.32L15.46 5Z" fill="currentColor" opacity="0.7"/>
            <path d="M12 2L10 5H14L12 2Z" fill="currentColor"/>
            <path d="M11 14H13V22H11V14Z" fill="currentColor" opacity="0.6"/>
            <path d="M18.66 12H5.34C4.8 12 4.41 12.54 4.58 13.04L6.58 19.04C6.75 19.54 7.2 20 7.72 20H16.28C16.8 20 17.25 19.54 17.42 19.04L19.42 13.04C19.59 12.54 19.2 12 18.66 12Z" fill="currentColor"/>
          </svg>
        );

        const NotificationIcon = ({ count, onClick }) => (
            <div className="relative cursor-pointer" onClick={onClick}>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-gray-600">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" /><path d="M13.73 21a2 2 0 0 1-3.46 0" />
                </svg>
                {count > 0 && (
                    <span className="absolute -top-2 -right-2 flex h-6 w-6 items-center justify-center rounded-full bg-red-500 text-xs font-bold text-white ring-2 ring-white">
                        {count > 99 ? '99+' : count}
                    </span>
                )}
            </div>
        );

        // --- INITIAL DATABASE SETUP ---
        const useDatabase = () => {
            const initializeData = () => {
                console.log("Initializing database for the first time...");
                const initialUsers = [
                    { id: 1, username: 'superadmin', password: 'superadmin', role: 'admin', approved: true },
                    { id: 2, username: 'admin', password: 'admin', role: 'admin', approved: true },
                    { id: 3, username: 'XI-A_user', password: 'password', role: 'user', className: 'XI-A', approved: true },
                ];
                const initialSchedules = {
                    'XI-A': {
                        Senin: [{ start: '07:00', end: '08:30', subject: 'Matematika' }, { start: '08:30', end: '10:00', subject: 'Fisika' }],
                        Selasa: [{ start: '07:00', end: '08:30', subject: 'Kimia' }],
                    }
                };
                const initialAssignments = [
                    { id: 1, title: 'Tugas Kalkulus', content: 'Kerjakan LKS hal 50.', className: 'XI-A', createdAt: new Date().toISOString() }
                ];
                const initialNotes = [
                    { id: 1, userId: 3, date: 'Senin', content: 'Jangan lupa bawa kalkulator.' }
                ];

                localStorage.setItem('users', JSON.stringify(initialUsers));
                localStorage.setItem('schedules', JSON.stringify(initialSchedules));
                localStorage.setItem('assignments', JSON.stringify(initialAssignments));
                localStorage.setItem('notes', JSON.stringify(initialNotes));
                localStorage.setItem('pendingUsers', JSON.stringify([]));
                localStorage.setItem('notifications', JSON.stringify([]));
                
                return { 
                    users: initialUsers, 
                    schedules: initialSchedules, 
                    assignments: initialAssignments, 
                    notes: initialNotes, 
                    pendingUsers: [],
                    notifications: [] 
                };
            };

            const loadData = (key, defaultValue = []) => {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : defaultValue;
                } catch (error) {
                    console.error(`Error loading ${key} from localStorage`, error);
                    return defaultValue;
                }
            };
            
            const [db, setDb] = useState(() => {
                const isInitialized = localStorage.getItem('users');
                if (!isInitialized) {
                    return initializeData();
                }
                return {
                    users: loadData('users'),
                    schedules: loadData('schedules', {}),
                    assignments: loadData('assignments'),
                    notes: loadData('notes'),
                    pendingUsers: loadData('pendingUsers'),
                    notifications: loadData('notifications', []),
                };
            });

            const updateDb = (key, data) => {
                localStorage.setItem(key, JSON.stringify(data));
                setDb(prevDb => ({ ...prevDb, [key]: data }));
            };

            return { db, updateDb };
        };


        // --- MAIN APP COMPONENT ---
        function App() {
            const { db, updateDb } = useDatabase();
            const [currentUser, setCurrentUser] = useState(null);
            const [page, setPage] = useState('login');
            const [backgroundPos, setBackgroundPos] = useState(0);

            const CLASS_LIST = useMemo(() => {
                const grades = ['X', 'XI', 'XII'];
                const majors = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L'];
                return grades.flatMap(grade => majors.map(major => `${grade}-${major}`));
            }, []);

            const DAYS = useMemo(() => ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'], []);

            useEffect(() => {
                const sessionUser = sessionStorage.getItem('currentUser');
                if (sessionUser) {
                    const user = JSON.parse(sessionUser);
                    setCurrentUser(user);
                    setPage(user.role);
                }
            }, []);

            const navigate = (newPage) => {
                setPage(newPage);
                if (newPage !== 'login') {
                    setBackgroundPos(prev => prev - 100);
                }
            };

            const handleLogin = ({ username, password }) => {
                const user = db.users.find(u => u.username === username && u.password === password);
                if (user && user.approved) {
                    setCurrentUser(user);
                    sessionStorage.setItem('currentUser', JSON.stringify(user));
                    navigate(user.role);
                    return true;
                }
                alert('Username atau password salah, atau akun belum disetujui.');
                return false;
            };
            
            const handleRegister = ({ username, password, className, role }) => {
                if (db.users.some(u => u.username === username) || db.pendingUsers.some(u => u.username === username)) {
                    alert('Username sudah digunakan atau sedang dalam proses persetujuan.');
                    return false;
                }
                
                const newUser = {
                    id: Date.now(),
                    username,
                    password,
                    role,
                    className: role === 'user' ? className : null,
                    approved: false
                };

                updateDb('pendingUsers', [...db.pendingUsers, newUser]);
                alert('Registrasi berhasil! Akun Anda sedang menunggu persetujuan dari Admin.');
                return true;
            };

            const handleLogout = () => {
                setCurrentUser(null);
                sessionStorage.removeItem('currentUser');
                setBackgroundPos(0);
                navigate('login');
            };

            const renderPage = () => {
                switch (page) {
                    case 'admin':
                        return <AdminDashboard 
                                currentUser={currentUser} 
                                db={db} 
                                updateDb={updateDb} 
                                CLASS_LIST={CLASS_LIST} 
                                DAYS={DAYS} 
                                onLogout={handleLogout} 
                                />;
                    case 'user':
                        return <UserDashboard 
                                currentUser={currentUser} 
                                db={db} 
                                updateDb={updateDb} 
                                DAYS={DAYS} 
                                onLogout={handleLogout}
                                />;
                    default:
                        return <LoginPage onLogin={handleLogin} onRegister={handleRegister} CLASS_LIST={CLASS_LIST} />;
                }
            };

            return (
                <div className="min-h-screen bg-green-50 font-sans text-gray-800">
                    <div 
                        className="fixed inset-0 z-0 bg-cover bg-center transition-transform duration-1000 ease-in-out"
                        style={{
                            backgroundImage: "url('https://images.unsplash.com/photo-1501854140801-50d01698950b?q=80&w=2400&auto=format&fit=crop')",
                            transform: `translateX(${backgroundPos}px)`
                        }}
                    ></div>
                    <div className="fixed inset-0 bg-black/30 z-0"></div>

                    <main className="relative z-10">
                        <div key={page} className="page-slide-in p-4 sm:p-6 md:p-8">
                           {renderPage()}
                        </div>
                    </main>
                </div>
            );
        }

        function LoginPage({ onLogin, onRegister, CLASS_LIST }) {
            const [isRegister, setIsRegister] = useState(false);
            const [form, setForm] = useState({ username: '', password: '', className: CLASS_LIST[0], role: 'user' });
            const [confirmPassword, setConfirmPassword] = useState('');

            const handleChange = (e) => {
                const { name, value } = e.target;
                setForm(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (isRegister) {
                    if (form.password !== confirmPassword) {
                        alert("Password tidak cocok!");
                        return;
                    }
                    if(onRegister(form)) {
                        setIsRegister(false);
                        setForm({ username: '', password: '', className: CLASS_LIST[0], role: 'user' });
                        setConfirmPassword('');
                    }
                } else {
                    onLogin(form);
                }
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-[calc(100vh-4rem)]">
                    <div className="w-full max-w-md p-8 space-y-6 bg-white/80 backdrop-blur-md rounded-2xl shadow-2xl">
                        <div className="flex justify-center">
                            <TreeLogo />
                        </div>
                        <h2 className="text-center text-3xl font-extrabold text-gray-900">{isRegister ? 'Buat Akun Baru' : 'Selamat Datang'}</h2>
                        
                        <form className="space-y-6" onSubmit={handleSubmit}>
                            <div className="space-y-4 rounded-md shadow-sm">
                                <input name="username" type="text" required value={form.username} onChange={handleChange} className="w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-green-500 focus:border-green-500" placeholder="Username" />
                                <input name="password" type="password" required value={form.password} onChange={handleChange} className="w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-green-500 focus:border-green-500" placeholder="Password" />
                                {isRegister && (
                                    <>
                                        <input name="confirmPassword" type="password" required value={confirmPassword} onChange={(e) => setConfirmPassword(e.target.value)} className="w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-green-500 focus:border-green-500" placeholder="Konfirmasi Password" />
                                        <div className="flex items-center space-x-4">
                                            <label><input type="radio" name="role" value="user" checked={form.role === 'user'} onChange={handleChange} /> User</label>
                                            <label><input type="radio" name="role" value="admin" checked={form.role === 'admin'} onChange={handleChange} /> Admin</label>
                                        </div>
                                        {form.role === 'user' && (
                                            <select name="className" value={form.className} onChange={handleChange} className="w-full px-3 py-2 border border-gray-300 text-gray-900 rounded-md focus:outline-none focus:ring-green-500 focus:border-green-500">
                                                {CLASS_LIST.map(c => <option key={c} value={c}>{c}</option>)}
                                            </select>
                                        )}
                                    </>
                                )}
                            </div>
                            <button type="submit" className="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out">
                                {isRegister ? 'Daftar' : 'Login'}
                            </button>
                        </form>

                        <p className="text-center text-sm">
                            {isRegister ? 'Sudah punya akun?' : 'Belum punya akun?'}
                            <button onClick={() => setIsRegister(!isRegister)} className="ml-1 font-medium text-green-600 hover:text-green-500">
                                {isRegister ? 'Login di sini' : 'Daftar sekarang'}
                            </button>
                        </p>
                    </div>
                </div>
            );
        }

        function AdminDashboard({ currentUser, db, updateDb, CLASS_LIST, DAYS, onLogout }) {
            const [activeTab, setActiveTab] = useState('approval');

            const handleApproval = (userId, isApproved) => {
                const userToProcess = db.pendingUsers.find(u => u.id === userId);
                if (!userToProcess) return;

                if (isApproved) {
                    const approvedUser = { ...userToProcess, approved: true };
                    updateDb('users', [...db.users, approvedUser]);
                    alert(`Registrasi ${userToProcess.username} disetujui.`);
                } else {
                    alert(`Registrasi ${userToProcess.username} ditolak.`);
                }
                
                updateDb('pendingUsers', db.pendingUsers.filter(u => u.id !== userId));
            };
            
            return (
                <div className="bg-white/80 backdrop-blur-md rounded-2xl shadow-xl p-6 min-h-[calc(100vh-4rem)]">
                    <header className="flex justify-between items-center mb-6 pb-4 border-b border-green-200">
                        <div className="flex items-center space-x-3">
                            <TreeLogo />
                            <div>
                                <h1 className="text-2xl font-bold text-green-800">Dasbor Admin</h1>
                                <p className="text-sm text-gray-600">Selamat datang, {currentUser.username}</p>
                            </div>
                        </div>
                        <button onClick={onLogout} className="px-4 py-2 text-sm font-medium rounded-md text-white bg-red-500 hover:bg-red-600 transition">Logout</button>
                    </header>
                    
                    <nav className="flex flex-wrap border-b mb-6 -mx-1">
                         <button onClick={() => setActiveTab('approval')} className={`px-4 py-2 rounded-t-lg mx-1 mb-[-1px] ${activeTab === 'approval' ? 'bg-green-100 text-green-800 font-semibold border border-b-white border-gray-200' : 'text-gray-600 hover:bg-green-50'}`}>Persetujuan Registrasi</button>
                        <button onClick={() => setActiveTab('schedule')} className={`px-4 py-2 rounded-t-lg mx-1 mb-[-1px] ${activeTab === 'schedule' ? 'bg-green-100 text-green-800 font-semibold border border-b-white border-gray-200' : 'text-gray-600 hover:bg-green-50'}`}>Manajemen Jadwal</button>
                        <button onClick={() => setActiveTab('assignments')} className={`px-4 py-2 rounded-t-lg mx-1 mb-[-1px] ${activeTab === 'assignments' ? 'bg-green-100 text-green-800 font-semibold border border-b-white border-gray-200' : 'text-gray-600 hover:bg-green-50'}`}>Manajemen Tugas</button>
                        <button onClick={() => setActiveTab('notes')} className={`px-4 py-2 rounded-t-lg mx-1 mb-[-1px] ${activeTab === 'notes' ? 'bg-green-100 text-green-800 font-semibold border border-b-white border-gray-200' : 'text-gray-600 hover:bg-green-50'}`}>Lihat Catatan User</button>
                    </nav>

                    <div className="transition-all duration-300">
                        {activeTab === 'approval' && <RegistrationApproval currentUser={currentUser} pendingUsers={db.pendingUsers} onApprove={handleApproval} updateDb={updateDb} existingUsers={db.users}/>}
                        {activeTab === 'schedule' && <ScheduleManager db={db} updateDb={updateDb} CLASS_LIST={CLASS_LIST} DAYS={DAYS} />}
                        {activeTab === 'assignments' && <AssignmentManager db={db} updateDb={updateDb} CLASS_LIST={CLASS_LIST} />}
                        {activeTab === 'notes' && <UserNotesViewer notes={db.notes} users={db.users} />}
                    </div>
                </div>
            );
        }
        
        function RegistrationApproval({ currentUser, pendingUsers, onApprove, updateDb, existingUsers }) {
            const userFileInputRef = useRef(null);
            const [userFileName, setUserFileName] = useState('');
            const isSuperAdmin = currentUser.username === 'superadmin';
            const adminFileInputRef = useRef(null);
            const [adminFileName, setAdminFileName] = useState('');

            const processUserData = (data) => {
                const newPendingUsers = [];
                const allUsernames = new Set([...existingUsers.map(u => u.username), ...pendingUsers.map(u => u.username)]);
                
                data.forEach(row => {
                    const { username, password, className } = row;
                    if (username && password && className && !allUsernames.has(username)) {
                        newPendingUsers.push({
                            id: Date.now() + Math.random(),
                            username,
                            password: String(password),
                            className,
                            role: 'user',
                            approved: false
                        });
                        allUsernames.add(username);
                    }
                });

                if (newPendingUsers.length > 0) {
                    updateDb('pendingUsers', [...pendingUsers, ...newPendingUsers]);
                    alert(`${newPendingUsers.length} user baru dari file telah ditambahkan ke daftar persetujuan.`);
                } else {
                    alert('Tidak ada user baru yang valid untuk ditambahkan. Pastikan file memiliki kolom header "username", "password", "className" dan tidak ada username yang duplikat.');
                }
            };

            const handleUserFileChange = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                setUserFileName(file.name);
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        processUserData(jsonData);
                    } catch (error) {
                         alert('Gagal memproses file: ' + error.message);
                    }
                };
                reader.readAsArrayBuffer(file);
                if(userFileInputRef.current) userFileInputRef.current.value = '';
                setUserFileName('');
            };
            
            const processAdminData = (data) => {
                const newPendingAdmins = [];
                const allUsernames = new Set([...existingUsers.map(u => u.username), ...pendingUsers.map(u => u.username)]);
                
                data.forEach(row => {
                    const { username, password } = row;
                    if (username && password && !allUsernames.has(username)) {
                        newPendingAdmins.push({
                            id: Date.now() + Math.random(),
                            username,
                            password: String(password),
                            className: null,
                            role: 'admin',
                            approved: false
                        });
                        allUsernames.add(username);
                    }
                });

                if (newPendingAdmins.length > 0) {
                    updateDb('pendingUsers', [...pendingUsers, ...newPendingAdmins]);
                    alert(`${newPendingAdmins.length} admin baru dari file telah ditambahkan ke daftar persetujuan.`);
                } else {
                    alert('Tidak ada admin baru yang valid untuk ditambahkan. Pastikan file memiliki kolom header "username" dan "password", dan tidak ada username yang duplikat.');
                }
            };

            const handleAdminFileChange = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                setAdminFileName(file.name);
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        processAdminData(jsonData);
                    } catch (error) {
                         alert('Gagal memproses file: ' + error.message);
                    }
                };
                reader.readAsArrayBuffer(file);
                if(adminFileInputRef.current) adminFileInputRef.current.value = '';
                setAdminFileName('');
            };

            const usersToDisplay = isSuperAdmin ? pendingUsers : pendingUsers.filter(u => u.role === 'user');

            return (
                <div>
                     <div className="p-4 bg-green-50 rounded-lg border border-green-200 mb-6">
                         <h3 className="font-bold text-lg text-green-700 mb-2">Impor User (Siswa) dari File</h3>
                         <p className="text-sm text-gray-600 mb-4">
                             Unggah file <strong>Excel (.xlsx, .xls)</strong>.
                             Pastikan file memiliki kolom header: <strong>username, password, className</strong>.
                         </p>
                         <input type="file" accept=".xlsx,.xls" ref={userFileInputRef} onChange={handleUserFileChange} className="hidden" id="user-file-importer" />
                         <label htmlFor="user-file-importer" className="file-input-button">Pilih File User</label>
                         {userFileName && <span className="file-input-label">{userFileName}</span>}
                     </div>

                    {isSuperAdmin && (
                         <div className="p-4 bg-blue-50 rounded-lg border border-blue-200 mb-6">
                             <h3 className="font-bold text-lg text-blue-700 mb-2">Impor Admin dari File (Superadmin Only)</h3>
                             <p className="text-sm text-gray-600 mb-4">
                                 Unggah file <strong>Excel (.xlsx, .xls)</strong>.
                                 Pastikan file memiliki kolom header: <strong>username, password</strong>.
                             </p>
                             <input type="file" accept=".xlsx,.xls" ref={adminFileInputRef} onChange={handleAdminFileChange} className="hidden" id="admin-file-importer" />
                             <label htmlFor="admin-file-importer" className="file-input-button bg-blue-500 hover:bg-blue-600">Pilih File Admin</label>
                             {adminFileName && <span className="file-input-label">{adminFileName}</span>}
                         </div>
                    )}

                    <h3 className="font-bold text-lg mb-4">Daftar Registrasi Menunggu Persetujuan</h3>
                    <div className="space-y-3 max-h-[50vh] overflow-y-auto pr-2">
                        {usersToDisplay.length > 0 ? usersToDisplay.map(user => (
                            <div key={user.id} className="flex flex-wrap justify-between items-center p-3 bg-white rounded-md shadow-sm">
                                <div>
                                    <p>Username: <span className="font-semibold">{user.username}</span></p>
                                    <p className="text-sm text-gray-500">
                                        Role: <span className="capitalize font-medium">{user.role}</span>
                                        {user.role === 'user' && ` - Kelas: ${user.className}`}
                                    </p>
                                </div>
                                <div className="flex space-x-2 mt-2 sm:mt-0">
                                    <button onClick={() => onApprove(user.id, true)} className="bg-green-500 text-white px-3 py-1 rounded-md text-sm hover:bg-green-600">Setujui</button>
                                    <button onClick={() => onApprove(user.id, false)} className="bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600">Tolak</button>
                                </div>
                            </div>
                        )) : <p className="text-gray-500">Tidak ada pendaftaran yang menunggu persetujuan.</p>}
                    </div>
                </div>
            );
        }

        function ScheduleManager({ db, updateDb, CLASS_LIST, DAYS }) {
            const [selectedClass, setSelectedClass] = useState(CLASS_LIST[0]);
            const [editingSchedule, setEditingSchedule] = useState(null); // {day, index, data}
            const [newSchedule, setNewSchedule] = useState({ day: DAYS[0], start: '07:00', end: '08:30', subject: '' });
            const fileInputRef = useRef(null);
            
            const createScheduleNotifications = (classNames, action) => {
                const affectedUsers = db.users.filter(user => classNames.includes(user.className));
                const content = action === 'delete' 
                    ? `Salah satu jadwal untuk kelas Anda telah dihapus.`
                    : `Jadwal untuk kelas Anda telah diperbarui.`;

                const newNotifications = affectedUsers.map(user => ({
                    id: Date.now() + Math.random(),
                    userId: user.id,
                    type: 'schedule_update',
                    content,
                    timestamp: new Date().toISOString(),
                    isRead: false
                }));
                if (newNotifications.length > 0) {
                    updateDb('notifications', [...db.notifications, ...newNotifications]);
                }
            };
            
            const handleUpdate = (newSchedules, updatedClasses, action = 'update') => {
                updateDb('schedules', newSchedules);
                createScheduleNotifications(updatedClasses, action);
            };

            const processScheduleData = (data) => {
                const newSchedules = JSON.parse(JSON.stringify(db.schedules));
                let importCount = 0;
                const updatedClasses = new Set();
                data.forEach(row => {
                    const { className, day, start, end, subject } = row;
                    if (className && day && DAYS.includes(day) && start && end && subject) {
                        if (!newSchedules[className]) newSchedules[className] = {};
                        if (!newSchedules[className][day]) newSchedules[className][day] = [];
                        
                        newSchedules[className][day].push({ start, end, subject });
                        updatedClasses.add(className);
                        importCount++;
                    }
                });

                // Sort schedules for each updated class and day
                updatedClasses.forEach(className => {
                    Object.keys(newSchedules[className]).forEach(day => {
                        newSchedules[className][day].sort((a, b) => a.start.localeCompare(b.start));
                    });
                });

                if (importCount > 0) {
                    handleUpdate(newSchedules, Array.from(updatedClasses));
                    alert(`${importCount} jadwal berhasil diimpor.`);
                } else {
                    alert('Tidak ada data jadwal yang valid untuk diimpor. Pastikan file memiliki kolom: className, day, start, end, subject.');
                }
            };
            
            const handleFileChange = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        processScheduleData(jsonData);
                    } catch (error) {
                        alert('Gagal memproses file: ' + error.message);
                    }
                };
                reader.readAsArrayBuffer(file);
                if (fileInputRef.current) fileInputRef.current.value = '';
            };
            
            const handleFormChange = (e) => {
                const { name, value } = e.target;
                if (editingSchedule) {
                    setEditingSchedule(prev => ({...prev, data: {...prev.data, [name]: value }}));
                } else {
                    setNewSchedule(prev => ({ ...prev, [name]: value }));
                }
            };

            const handleFormSubmit = (e) => {
                e.preventDefault();
                const currentData = editingSchedule ? editingSchedule.data : newSchedule;
                if (!currentData.subject) {
                    alert('Mata pelajaran tidak boleh kosong.');
                    return;
                }

                const newSchedules = JSON.parse(JSON.stringify(db.schedules));
                if (!newSchedules[selectedClass]) newSchedules[selectedClass] = {};
                if (!newSchedules[selectedClass][currentData.day]) newSchedules[selectedClass][currentData.day] = [];
                
                if (editingSchedule) {
                    // Update existing
                    newSchedules[selectedClass][editingSchedule.day][editingSchedule.index] = currentData;
                } else {
                    // Add new
                    newSchedules[selectedClass][currentData.day].push(currentData);
                }

                // Sort
                newSchedules[selectedClass][currentData.day].sort((a, b) => a.start.localeCompare(b.start));

                handleUpdate(newSchedules, [selectedClass]);
                setNewSchedule({ day: DAYS[0], start: '07:00', end: '08:30', subject: '' });
                setEditingSchedule(null);
            };

            const handleDelete = (day, index) => {
                if (!confirm('Apakah Anda yakin ingin menghapus jadwal ini?')) return;
                const newSchedules = JSON.parse(JSON.stringify(db.schedules));
                newSchedules[selectedClass][day].splice(index, 1);
                handleUpdate(newSchedules, [selectedClass], 'delete');
            };

            const currentClassSchedule = db.schedules[selectedClass] || {};

            return (
                <div>
                    <div className="p-4 bg-green-50 rounded-lg border border-green-200 mb-6">
                         <h3 className="font-bold text-lg text-green-700 mb-2">Impor Jadwal dari File</h3>
                         <p className="text-sm text-gray-600 mb-4">
                             Unggah file <strong>Excel (.xlsx, .xls)</strong>.
                             Pastikan file memiliki kolom header: <strong>className, day, start, end, subject</strong>.
                         </p>
                         <input type="file" accept=".xlsx,.xls" ref={fileInputRef} onChange={handleFileChange} className="hidden" id="schedule-file-importer" />
                         <label htmlFor="schedule-file-importer" className="file-input-button">Pilih File Jadwal</label>
                    </div>

                    <div className="flex flex-wrap items-center gap-4 mb-4">
                        <label htmlFor="class-select" className="font-semibold">Pilih Kelas:</label>
                        <select id="class-select" value={selectedClass} onChange={e => setSelectedClass(e.target.value)} className="p-2 border rounded-md">
                            {CLASS_LIST.map(c => <option key={c} value={c}>{c}</option>)}
                        </select>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="md:col-span-1 p-4 bg-white rounded-lg shadow">
                            <h3 className="font-bold text-lg mb-4">{editingSchedule ? 'Edit Jadwal' : 'Tambah Jadwal Baru'}</h3>
                            <form onSubmit={handleFormSubmit} className="space-y-4">
                                <select name="day" value={editingSchedule ? editingSchedule.data.day : newSchedule.day} onChange={handleFormChange} className="w-full p-2 border rounded-md">
                                    {DAYS.map(d => <option key={d} value={d}>{d}</option>)}
                                </select>
                                <div className="flex gap-2">
                                    <input type="time" name="start" value={editingSchedule ? editingSchedule.data.start : newSchedule.start} onChange={handleFormChange} className="w-full p-2 border rounded-md" />
                                    <input type="time" name="end" value={editingSchedule ? editingSchedule.data.end : newSchedule.end} onChange={handleFormChange} className="w-full p-2 border rounded-md" />
                                </div>
                                <input type="text" name="subject" placeholder="Mata Pelajaran" value={editingSchedule ? editingSchedule.data.subject : newSchedule.subject} onChange={handleFormChange} className="w-full p-2 border rounded-md" />
                                <div className="flex gap-2">
                                    <button type="submit" className="w-full bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">{editingSchedule ? 'Update' : 'Tambah'}</button>
                                    {editingSchedule && <button type="button" onClick={() => setEditingSchedule(null)} className="w-full bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Batal</button>}
                                </div>
                            </form>
                        </div>
                        <div className="md:col-span-2 p-4 bg-white rounded-lg shadow max-h-[70vh] overflow-y-auto">
                            <h3 className="font-bold text-lg mb-4">Jadwal Kelas {selectedClass}</h3>
                            <div className="space-y-4">
                                {DAYS.map(day => (
                                    <div key={day}>
                                        <h4 className="font-semibold text-green-700">{day}</h4>
                                        {currentClassSchedule[day] && currentClassSchedule[day].length > 0 ? (
                                            <ul className="list-disc list-inside space-y-2 mt-2">
                                                {currentClassSchedule[day].map((item, index) => (
                                                    <li key={index} className="flex justify-between items-center p-2 bg-gray-50 rounded-md">
                                                        <span><strong>{item.start} - {item.end}</strong>: {item.subject}</span>
                                                        <div className="flex gap-2">
                                                            <button onClick={() => setEditingSchedule({ day, index, data: item })} className="text-blue-500 hover:underline text-sm">Edit</button>
                                                            <button onClick={() => handleDelete(day, index)} className="text-red-500 hover:underline text-sm">Hapus</button>
                                                        </div>
                                                    </li>
                                                ))}
                                            </ul>
                                        ) : <p className="text-gray-500 text-sm italic mt-1">Tidak ada jadwal.</p>}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function AssignmentManager({ db, updateDb, CLASS_LIST }) {
            const [assignments, setAssignments] = useState(db.assignments);
            const [form, setForm] = useState({ title: '', content: '', className: CLASS_LIST[0] });
            const [editingId, setEditingId] = useState(null);

            useEffect(() => {
                setAssignments(db.assignments);
            }, [db.assignments]);
            
            const createAssignmentNotification = (className, title) => {
                const affectedUsers = db.users.filter(user => user.className === className);
                const newNotifications = affectedUsers.map(user => ({
                    id: Date.now() + Math.random(),
                    userId: user.id,
                    type: 'new_assignment',
                    content: `Tugas baru ditambahkan: "${title}" untuk kelas ${className}.`,
                    timestamp: new Date().toISOString(),
                    isRead: false
                }));
                if (newNotifications.length > 0) {
                    updateDb('notifications', [...db.notifications, ...newNotifications]);
                }
            };
            
            const handleChange = (e) => {
                setForm({...form, [e.target.name]: e.target.value});
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if(!form.title || !form.content) {
                    alert("Judul dan konten tugas tidak boleh kosong.");
                    return;
                }

                let updatedAssignments;
                if (editingId) {
                    updatedAssignments = assignments.map(a => a.id === editingId ? { ...a, ...form } : a);
                } else {
                    const newAssignment = { ...form, id: Date.now(), createdAt: new Date().toISOString() };
                    updatedAssignments = [...assignments, newAssignment];
                    createAssignmentNotification(form.className, form.title);
                }
                updateDb('assignments', updatedAssignments);
                setForm({ title: '', content: '', className: CLASS_LIST[0] });
                setEditingId(null);
            };

            const handleEdit = (assignment) => {
                setEditingId(assignment.id);
                setForm({ title: assignment.title, content: assignment.content, className: assignment.className });
            };

            const handleDelete = (id) => {
                if(confirm("Apakah Anda yakin ingin menghapus tugas ini?")) {
                    updateDb('assignments', assignments.filter(a => a.id !== id));
                }
            };

            return (
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div className="md:col-span-1 p-4 bg-white rounded-lg shadow">
                         <h3 className="font-bold text-lg mb-4">{editingId ? 'Edit Tugas' : 'Tambah Tugas Baru'}</h3>
                         <form onSubmit={handleSubmit} className="space-y-4">
                            <input type="text" name="title" placeholder="Judul Tugas" value={form.title} onChange={handleChange} className="w-full p-2 border rounded-md" />
                            <textarea name="content" placeholder="Konten Tugas" value={form.content} onChange={handleChange} className="w-full p-2 border rounded-md h-32"></textarea>
                            <select name="className" value={form.className} onChange={handleChange} className="w-full p-2 border rounded-md">
                                {CLASS_LIST.map(c => <option key={c} value={c}>{c}</option>)}
                            </select>
                             <div className="flex gap-2">
                                 <button type="submit" className="w-full bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">{editingId ? 'Update' : 'Tambah'}</button>
                                 {editingId && <button type="button" onClick={() => { setEditingId(null); setForm({ title: '', content: '', className: CLASS_LIST[0] });}} className="w-full bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Batal</button>}
                            </div>
                         </form>
                    </div>
                     <div className="md:col-span-2 p-4 bg-white rounded-lg shadow max-h-[70vh] overflow-y-auto">
                         <h3 className="font-bold text-lg mb-4">Daftar Tugas</h3>
                         <div className="space-y-4">
                            {assignments.length > 0 ? [...assignments].reverse().map(assignment => (
                                <div key={assignment.id} className="p-4 bg-gray-50 rounded-lg border">
                                    <p className="font-bold">{assignment.title} <span className="text-sm font-normal text-gray-500">- {assignment.className}</span></p>
                                    <p className="my-1">{assignment.content}</p>
                                    <p className="text-xs text-gray-400">Dibuat: {new Date(assignment.createdAt).toLocaleString()}</p>
                                     <div className="flex gap-2 mt-2">
                                         <button onClick={() => handleEdit(assignment)} className="text-blue-500 hover:underline text-sm">Edit</button>
                                         <button onClick={() => handleDelete(assignment.id)} className="text-red-500 hover:underline text-sm">Hapus</button>
                                    </div>
                                </div>
                            )) : <p className="text-gray-500">Belum ada tugas.</p>}
                         </div>
                    </div>
                </div>
            );
        }

        function UserNotesViewer({ notes, users }) {
            const userMap = useMemo(() => {
                return users.reduce((map, user) => {
                    map[user.id] = user;
                    return map;
                }, {});
            }, [users]);
            
            return (
                 <div className="p-4 bg-white rounded-lg shadow max-h-[70vh] overflow-y-auto">
                     <h3 className="font-bold text-lg mb-4">Catatan Semua User</h3>
                     <div className="space-y-4">
                        {notes.length > 0 ? notes.map(note => (
                             <div key={note.id} className="p-3 bg-yellow-50 rounded-md border border-yellow-200">
                                 <p className="font-semibold">
                                    {userMap[note.userId] ? `${userMap[note.userId].username} (${userMap[note.userId].className})` : 'User tidak diketahui'}
                                    <span className="text-sm font-normal text-gray-600"> - Catatan untuk hari {note.date}</span>
                                 </p>
                                 <p className="mt-1">{note.content}</p>
                             </div>
                        )) : <p className="text-gray-500">Belum ada catatan dari user.</p>}
                     </div>
                </div>
            );
        }

        function UserDashboard({ currentUser, db, updateDb, DAYS, onLogout }) {
            const [activeTab, setActiveTab] = useState('today');
            const [showNotifications, setShowNotifications] = useState(false);

            const userNotifications = useMemo(() => {
                return db.notifications
                    .filter(n => n.userId === currentUser.id)
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            }, [db.notifications, currentUser.id]);

            const unreadCount = useMemo(() => {
                return userNotifications.filter(n => !n.isRead).length;
            }, [userNotifications]);

            const handleMarkAsRead = () => {
                const updatedNotifications = db.notifications.map(n => 
                    n.userId === currentUser.id ? { ...n, isRead: true } : n
                );
                updateDb('notifications', updatedNotifications);
            };

            const toggleNotifications = () => {
                setShowNotifications(prev => !prev);
                if (!showNotifications && unreadCount > 0) {
                    handleMarkAsRead();
                }
            };

            const renderContent = () => {
                switch(activeTab) {
                    case 'today':
                        return <TodaySchedule currentUser={currentUser} schedule={db.schedules[currentUser.className]} DAYS={DAYS} />;
                    case 'full_schedule':
                        return <FullSchedule schedule={db.schedules[currentUser.className]} DAYS={DAYS} />;
                    case 'assignments':
                        return <AssignmentsView assignments={db.assignments.filter(a => a.className === currentUser.className)} />;
                    case 'notes':
                        return <UserNotes currentUser={currentUser} userNotes={db.notes.filter(n => n.userId === currentUser.id)} updateDb={updateDb} allNotes={db.notes} DAYS={DAYS} />;
                    default: return null;
                }
            }

            return (
                <div className="bg-white/80 backdrop-blur-md rounded-2xl shadow-xl p-6 min-h-[calc(100vh-4rem)]">
                    <header className="flex justify-between items-center mb-6 pb-4 border-b border-green-200">
                        <div className="flex items-center space-x-3">
                            <TreeLogo />
                            <div>
                                <h1 className="text-2xl font-bold text-green-800">Dasbor Siswa</h1>
                                <p className="text-sm text-gray-600">Selamat datang, {currentUser.username} (Kelas {currentUser.className})</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-6">
                            <NotificationIcon count={unreadCount} onClick={toggleNotifications} />
                            <button onClick={onLogout} className="px-4 py-2 text-sm font-medium rounded-md text-white bg-red-500 hover:bg-red-600 transition">Logout</button>
                        </div>
                    </header>

                    {showNotifications && (
                        <div className="absolute top-20 right-8 w-80 bg-white rounded-lg shadow-lg border z-20 max-h-96 overflow-y-auto">
                           <div className="p-3 border-b font-semibold">Notifikasi</div>
                           {userNotifications.length > 0 ? userNotifications.map(n => (
                               <div key={n.id} className={`p-3 border-b text-sm ${!n.isRead ? 'bg-green-50' : ''}`}>
                                   <p>{n.content}</p>
                                   <p className="text-xs text-gray-400 mt-1">{new Date(n.timestamp).toLocaleString()}</p>
                               </div>
                           )) : <div className="p-3 text-sm text-gray-500">Tidak ada notifikasi baru.</div>}
                        </div>
                    )}
                    
                    <nav className="flex flex-wrap border-b mb-6 -mx-1">
                         <button onClick={() => setActiveTab('today')} className={`px-4 py-2 rounded-t-lg mx-1 mb-[-1px] ${activeTab === 'today' ? 'bg-green-100 text-green-800 font-semibold border border-b-white border-gray-200' : 'text-gray-600 hover:bg-green-50'}`}>Jadwal Hari Ini</button>
                         <button onClick={() => setActiveTab('full_schedule')} className={`px-4 py-2 rounded-t-lg mx-1 mb-[-1px] ${activeTab === 'full_schedule' ? 'bg-green-100 text-green-800 font-semibold border border-b-white border-gray-200' : 'text-gray-600 hover:bg-green-50'}`}>Jadwal Lengkap</button>
                         <button onClick={() => setActiveTab('assignments')} className={`px-4 py-2 rounded-t-lg mx-1 mb-[-1px] ${activeTab === 'assignments' ? 'bg-green-100 text-green-800 font-semibold border border-b-white border-gray-200' : 'text-gray-600 hover:bg-green-50'}`}>Tugas</button>
                         <button onClick={() => setActiveTab('notes')} className={`px-4 py-2 rounded-t-lg mx-1 mb-[-1px] ${activeTab === 'notes' ? 'bg-green-100 text-green-800 font-semibold border border-b-white border-gray-200' : 'text-gray-600 hover:bg-green-50'}`}>Catatan Saya</button>
                    </nav>

                    <div>{renderContent()}</div>
                </div>
            );
        }

        // --- USER DASHBOARD SUB-COMPONENTS ---
        function TodaySchedule({ schedule, DAYS }) {
            const todayIndex = (new Date().getDay() + 6) % 7; // Monday = 0, Sunday = 6
            const todayName = todayIndex < 6 ? DAYS[todayIndex] : 'Minggu';
            const todaySchedule = schedule ? schedule[todayName] : [];

            return (
                <div className="p-4 bg-white rounded-lg shadow">
                    <h3 className="font-bold text-lg mb-4">Jadwal untuk hari {todayName}</h3>
                    {todaySchedule && todaySchedule.length > 0 ? (
                        <ul className="list-disc list-inside space-y-2">
                            {todaySchedule.map((item, index) => (
                                <li key={index}><strong>{item.start} - {item.end}</strong>: {item.subject}</li>
                            ))}
                        </ul>
                    ) : <p className="text-gray-500">Tidak ada jadwal untuk hari ini.</p>}
                </div>
            );
        }

        function FullSchedule({ schedule, DAYS }) {
             return (
                <div className="p-4 bg-white rounded-lg shadow max-h-[70vh] overflow-y-auto">
                    <h3 className="font-bold text-lg mb-4">Jadwal Lengkap</h3>
                    <div className="space-y-4">
                        {DAYS.map(day => (
                            <div key={day}>
                                <h4 className="font-semibold text-green-700">{day}</h4>
                                {schedule && schedule[day] && schedule[day].length > 0 ? (
                                    <ul className="list-disc list-inside space-y-2 mt-2">
                                        {schedule[day].map((item, index) => (
                                            <li key={index}><strong>{item.start} - {item.end}</strong>: {item.subject}</li>
                                        ))}
                                    </ul>
                                ) : <p className="text-gray-500 text-sm italic mt-1">Tidak ada jadwal.</p>}
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function AssignmentsView({ assignments }) {
            return (
                <div className="p-4 bg-white rounded-lg shadow max-h-[70vh] overflow-y-auto">
                     <h3 className="font-bold text-lg mb-4">Daftar Tugas</h3>
                     <div className="space-y-4">
                        {[...assignments].reverse().map(assignment => (
                            <div key={assignment.id} className="p-4 bg-gray-50 rounded-lg border">
                                <p className="font-bold">{assignment.title}</p>
                                <p className="my-1">{assignment.content}</p>
                                <p className="text-xs text-gray-400">Dibuat: {new Date(assignment.createdAt).toLocaleString()}</p>
                            </div>
                        ))}
                        {assignments.length === 0 && <p className="text-gray-500">Tidak ada tugas saat ini.</p>}
                     </div>
                </div>
            );
        }

        function UserNotes({ currentUser, userNotes, updateDb, allNotes, DAYS }) {
            const [note, setNote] = useState('');
            const [selectedDay, setSelectedDay] = useState(DAYS[0]);
            const [editingId, setEditingId] = useState(null);

            const handleDayChange = (e) => {
                setSelectedDay(e.target.value);
                const existingNote = userNotes.find(n => n.date === e.target.value);
                if (existingNote) {
                    setNote(existingNote.content);
                    setEditingId(existingNote.id);
                } else {
                    setNote('');
                    setEditingId(null);
                }
            };
            
            const handleSaveNote = () => {
                if (!note.trim()) {
                    alert("Catatan tidak boleh kosong.");
                    return;
                }
                let updatedNotes;
                if(editingId) {
                    updatedNotes = allNotes.map(n => n.id === editingId ? {...n, content: note} : n);
                } else {
                    const newNote = {
                        id: Date.now(),
                        userId: currentUser.id,
                        date: selectedDay,
                        content: note
                    };
                    updatedNotes = [...allNotes, newNote];
                }
                updateDb('notes', updatedNotes);
                alert(`Catatan untuk hari ${selectedDay} berhasil disimpan.`);
            };
            
             const handleDeleteNote = () => {
                if(!editingId || !confirm("Yakin ingin menghapus catatan ini?")) return;
                const updatedNotes = allNotes.filter(n => n.id !== editingId);
                updateDb('notes', updatedNotes);
                setNote('');
                setEditingId(null);
             };

            useEffect(() => {
                handleDayChange({ target: { value: selectedDay } });
            }, [userNotes, selectedDay]);


            return (
                 <div className="p-4 bg-white rounded-lg shadow">
                     <h3 className="font-bold text-lg mb-4">Catatan Pribadi</h3>
                     <div className="flex flex-wrap items-center gap-4 mb-4">
                        <label htmlFor="day-select" className="font-semibold">Pilih Hari:</label>
                        <select id="day-select" value={selectedDay} onChange={handleDayChange} className="p-2 border rounded-md">
                            {DAYS.map(d => <option key={d} value={d}>{d}</option>)}
                        </select>
                    </div>
                    <textarea 
                        value={note} 
                        onChange={(e) => setNote(e.target.value)}
                        placeholder={`Tulis catatan untuk hari ${selectedDay}...`}
                        className="w-full p-2 border rounded-md h-40 mb-4"
                    />
                    <div className="flex gap-2">
                        <button onClick={handleSaveNote} className="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">Simpan Catatan</button>
                        {editingId && <button onClick={handleDeleteNote} className="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">Hapus</button>}
                    </div>
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>

</body>
</html>
